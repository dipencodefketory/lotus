{% extends 'center/basis.html' %}
{% block title %}Produkte{% endblock %}

{% block addsheets %}
    <link rel="stylesheet" type="text/css" href="{{ url_for('static',filename='css/center/products.css')}}">
{% endblock %}

{% block ext %}
    <div class="alert alert-success small visible" id="price_update_message" style="position: absolute; left: 25%; width: 50%; top: -100%; z-index: 5000"></div>
    <div class="visible white tiny box100" style="text-align: left; position: relative">
        <div class="submenu five lightgrey">
            Produkte
        </div>
        <a class="blackfont" href="{{ url_for('center_product_groups') }}">
            <div class="submenu five">
                Produkt-Gruppen
            </div>
        </a>
        <a class="blackfont" href="{{ url_for('center_product_pim') }}">
            <div class="submenu five">
                PIM
            </div>
        </a>
        {% if 'Produkt-Management' in session.roles %}
            <a class="blackfont" href="{{ url_for('center_product_dynamic_pricing') }}">
                <div class="submenu five">
                    Dynamic Pricing
                </div>
            </a>
        {% endif %}
    </div>
    <div class="box100" style="text-align: left">
    <!--
        <a href="{{ url_for('center_product_addproduct') }}">
            <div class="standardbutton greenbutton visible">
                <i class="fa fa-plus" aria-hidden="true"></i> Produkt hinzufügen
            </div>
        </a>
    -->
    </div>
    <div class="box100 visible five" style="text-align: left">
        <div class="big seven" style="padding: 15px 0 10px 20px"><i>Filter</i></div>
        <form action="" method="POST" name="filterform" style="padding-top: 3px">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
            <div class="splitleft">
                <div class="form-goup">
                    <label for="keywords"> Suchbegriffe (an Semikolon trennen!):
                    </label>
                        <input class="reg" style="border: solid 1px black; width: 100%; display: block;" type="text" id="keywords" name="keywords"
                               value="{{ session['product_filter_infos']['keywords'] }}">
                </div>
                <div class="form-group" style="margin-top: 20px">
                    <label for="product_ids" style="width: 100%">Produkte (IDs an Semikolon trennen!)
                        <div style="float: right">
                            <input type="radio" value="id" id="id" class="id_type"
                                   name="id_type" onclick="transform_ids(this.value)"
                                    {% if 'product_id_type' in session['product_filter_infos'] %}
                                    {% if session['product_filter_infos']['product_id_type'] == 'id' %}
                                        checked
                                    {% endif %}
                                    {% else %}
                                        checked
                                    {% endif %}
                            >
                            <label for="id" style="margin: 0; padding-bottom: 0">ID
                            </label>
                            <input type="radio" value="Internal_ID" id="Internal_ID" class="id_type"
                                   name="id_type" onclick="transform_ids(this.value)"
                                    {% if 'product_id_type' in session['product_filter_infos'] %}
                                    {% if session['product_filter_infos']['product_id_type'] == 'Internal_ID' %}
                                        checked
                                    {% endif %}
                                    {% endif %}
                            >
                            <label for="Internal_ID" style="margin: 0; padding-bottom: 0">Interne ID
                            </label>
                            <input type="radio" value="HSP_ID" id="HSP_ID" class="id_type"
                                   name="id_type" onclick="transform_ids(this.value)"
                                    {% if 'product_id_type' in session['product_filter_infos'] %}
                                    {% if session['product_filter_infos']['product_id_type'] == 'HSP_ID' %}
                                        checked
                                    {% endif %}
                                    {% endif %}
                            >
                            <label for="HSP_ID" style="margin: 0; padding-bottom: 0">HSP-ID
                            </label>
                            <input hidden name="product_type" id="product_type" value="{{ session['product_filter_infos']['product_id_type'] if session['product_filter_infos']['product_id_type'] else 'id' }}">
                        </div>
                    </label>
                    <textarea rows="4" id="product_ids" style="border: solid 1px black;"  name="product_ids" class="form-control">{% for p in session['product_filter_infos']['product_ids'] %}{{ p }};{% endfor %}</textarea>
                    <span class="supertiny formwarning" id="product_ids_warning">Keine Eingabe!</span>
                    <div style="position:relative;">
                        <input type="text" name="product" style="border: solid 1px black;"  class="form-control" id="product" list="product-datalist" style="padding-right: 120px" onkeyup="find_products(this.value)">
                        <span class="supertiny formwarning" id="product_warning">Nur Ziffern erlaubt!</span>
                        <datalist id="product-datalist" onmouseover="show_filter_options('product')" onmouseleave="hide_filter_options('product')" >

                        </datalist>
                        <button type="button" class="fromfield_blackbutton" name="btn" onclick="add_product()" id="attributebtn">
                            <i class="fa fa-caret-up" aria-hidden="true"></i> hinzufügen
                        </button>
                    </div>
                </div>
            </div>
            <div class="splitright">
                <table class="table tiny" style="margin-bottom: 0; text-align: left; border: none; box-shadow: none">
                    <thead style="border: none; box-shadow: none">
                        <tr style="border: none; box-shadow: none">
                            <th style="border: none; box-shadow: none; width: 200px">
                                <div class="table_top_filter white" id="category-top_filter" onclick="show_filter_options('category')" onmouseover="show_filter_options('category')" onmouseleave="hide_filter_options('category')">
                                    <i class="fa fa-caret-down" aria-hidden="true"></i> Kategorien
                                    <div class="table_top_filter-dropdown visible" id="category-top_filter-dropdown" onmouseover="show_filter_options('category')" onmouseleave="hide_filter_options('category')">
                                        <table class="table">
                                            <tbody>
                                                <tr style="padding: 0; margin: 0">
                                                    <td style="padding: 0; margin: 0">
                                                        <label for="category" class="clickable_rowbox" style="height:100%; padding:5px; width: 100%">
                                                            <input type="checkbox" id="category" style="cursor: pointer; margin: 5px; position: relative; top:1.5px" onchange="selectall(this.checked, 'category')">
                                                            <i>Alle</i>
                                                        </label>
                                                    </td>
                                                </tr>
                                                {% for category in categories %}
                                                    <tr style="padding: 0; margin: 0">
                                                        <td style="padding: 0; margin: 0">
                                                            <label for="category{{ category.id }}" style="height:100%; padding:5px; width: 100%">
                                                                <input type="checkbox" value="{{ category.id }}" style="margin: 5px; position: relative; top:1.5px" class="category_filter" name="category_filter" id="category{{ category.id }}"
                                                                        {% if 'productcategory_ids' in session['product_filter_infos'] %}
                                                                        {% if category.id in session['product_filter_infos']['productcategory_ids'] %}
                                                                       checked
                                                                       {% endif %}{% endif %}> {{ category.name }}
                                                            </label>
                                                        </td>
                                                    </tr>
                                                {% endfor %}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </th>
                            <th style="border: none; box-shadow: none; padding-bottom: 12px">
                                <label for="short_sell_active">Leerverkauf aktiv:</label><br>
                                <i class="fa fa-check-circle-o" aria-hidden="true"></i> <input type="radio" id="short_sell_active" name="short_sell_active" value="1" style="position: relative; top: 1.5px" {% if 'short_sell_active' in session['product_filter_infos'] %}{% if session['product_filter_infos']['short_sell_active']==True %}checked{% endif %}{% endif %}>
                                <i class="fa fa-times-circle-o" aria-hidden="true"></i> <input type="radio" id="short_sell_active" name="short_sell_active" value="0" style="position: relative; top: 1.5px" {% if 'short_sell_active' in session['product_filter_infos'] %}{% if session['product_filter_infos']['short_sell_active']==False %}checked{% endif %}{% endif %}>
                                <i class="fa fa-circle-o" aria-hidden="true"></i> <input type="radio" id="short_sell_active" name="short_sell_active" value="" style="position: relative; top: 1.5px" {% if 'short_sell_active' in session['product_filter_infos'] %}{% if session['product_filter_infos']['short_sell_active']==None %}checked{% endif %}{% else %}checked{% endif %}>

                            </th>
                            <th style="position: relative; border: none; box-shadow: none; padding: 5px 5px 10px 5px; width: 200px">
                                <div style="width: 50%; float: left; padding-right: 15px">
                                    <label for="own_stock_min"> Lagerbestand Min:
                                    </label>
                                        <input class="form-control tiny" style="border: solid 1px black; display: block; width: 100%;" type="number" name="own_stock_min" id="own_stock_min" step="1"
                                               value="{{ session['product_filter_infos']['own_stock_min'] }}">
                                </div>
                                <div style="width: 50%; float: left; padding-left: 15px">
                                    <label for="own_stock_max"> Lagerbestand Max:
                                    </label>
                                        <input class="form-control tiny" style="border: solid 1px black; display: block; width: 100%;" type="number" name="own_stock_max" id="own_stock_max" step="1"
                                               value="{{ session['product_filter_infos']['own_stock_max'] }}">
                                </div>
                            </th>
                            <th style="border: none; box-shadow: none; padding: 5px 5px 10px 5px; width: 60px;">
                                <label for="filter_datalimit_page"> Anzeige pro Seite:
                                </label>
                                <input class="form-control tiny" style="border: solid 1px black; display: block; width: 100%;" type="number"
                                       name="limit_page" id="limit_page" min="1"
                                        {% if 'limit_page' in session['product_filter_infos'] %}
                                        value="{{ session['product_filter_infos']['limit_page'] }}"
                                       {% endif %}
                                >
                            </th>
                        </tr>
                        <tr>
                            <th style="border: none; box-shadow: none; padding-bottom: 5px;">
                                <div class="table_top_filter white" id="marketplace-top_filter" onclick="show_filter_options('marketplace')" onmouseover="show_filter_options('marketplace')" onmouseleave="hide_filter_options('marketplace')">
                                    <i class="fa fa-caret-down" aria-hidden="true"></i> Marketplaces
                                    <div class="table_top_filter-dropdown visible" id="marketplace-top_filter-dropdown" onmouseover="show_filter_options('marketplace')" onmouseleave="hide_filter_options('marketplace')">
                                        <table class="table">
                                            <tbody>
                                                {% for marketplace in marketplaces %}
                                                <tr style="padding: 0; margin: 0">
                                                    <td>
                                                        <label for="{{ marketplace.id }}listed" style="width: 100px;">{{ marketplace.name }} gelistet:</label>
                                                        <i class="fa fa-check-circle-o" aria-hidden="true"></i> <input type="radio" id="{{ marketplace.id }}listed" name="{{ marketplace.id }}listed" value="1" style="position: relative; top: 1.5px" {% if 'mp_listing_dict' in session['product_filter_infos'] %}{% if session['product_filter_infos']['mp_listing_dict'][marketplace.id|string]==True %}checked{% endif %}{% endif %}>
                                                        <i class="fa fa-times-circle-o" aria-hidden="true"></i> <input type="radio" id="{{ marketplace.id }}listed" name="{{ marketplace.id }}listed" value="0" style="position: relative; top: 1.5px" {% if 'mp_listing_dict' in session['product_filter_infos'] %}{% if session['product_filter_infos']['mp_listing_dict'][marketplace.id|string]==False %}checked{% endif %}{% endif %}>
                                                        <i class="fa fa-circle-o" aria-hidden="true"></i> <input type="radio" id="{{ marketplace.id }}listed" name="{{ marketplace.id }}listed" value="" style="position: relative; top: 1.5px" {% if 'mp_listing_dict' in session['product_filter_infos'] %}{% if session['product_filter_infos']['mp_listing_dict'][marketplace.id|string]==None %}checked{% endif %}{% else %}checked{% endif %}>
                                                    </td>
                                                </tr>
                                                {% endfor %}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </th>
                            <th style="border: none; box-shadow: none; padding-bottom: 5px; width: 120px;">
                                <label for="state">Suchmodus:</label><br>
                                <i class="fa fa-search" aria-hidden="true"></i> <input type="radio" id="state" name="state" value="0" style="position: relative; top: 1.5px" {% if 'state' in session['product_filter_infos'] %}{% if session['product_filter_infos']['state']==0 %}checked{% endif %}{% endif %}>
                                <i class="fa fa-exclamation" aria-hidden="true"></i> <input type="radio" id="state" name="state" value="1" style="position: relative; top: 1.5px" {% if 'state' in session['product_filter_infos'] %}{% if session['product_filter_infos']['state']==1 %}checked{% endif %}{% endif %}>
                                <i class="fa fa-check" aria-hidden="true"></i> <input type="radio" id="state" name="state" value="2" style="position: relative; top: 1.5px" {% if 'state' in session['product_filter_infos'] %}{% if session['product_filter_infos']['state']==2 %}checked{% endif %}{% else %}checked{% endif %}>
                                <i class="fa fa-circle-o" aria-hidden="true"></i> <input type="radio" id="state" name="state" value="" style="position: relative; top: 1.5px" {% if 'state' in session['product_filter_infos'] %}{% if session['product_filter_infos']['state']==None %}checked{% endif %}{% else %}checked{% endif %}>
                            </th>
                            <th style="border: none; box-shadow: none; padding-bottom: 5px; width: 120px;">
                                Verkauftszeitraum:<br>
                                <div style="width: 50%; float: left; padding-right: 15px">
                                    <label for="min_sell_date"> Start:
                                    </label>
                                    <input class="form-control tiny" style="border: solid 1px black; display: block; width: 100%;" type="date" name="min_sell_date" id="min_sell_date" value="{{ session['product_filter_infos']['min_sell_date'] }}">
                                </div>
                                <div style="width: 50%; float: left; padding-left: 15px">
                                    <label for="max_sell_date"> Ende:
                                    </label>
                                    <input class="form-control tiny" style="border: solid 1px black; display: block; width: 100%;" type="date" name="max_sell_date" id="max_sell_date" value="{{ session['product_filter_infos']['max_sell_date'] }}">
                                </div>
                            </th>
                            <th style="border: none; box-shadow: none; padding: 10px 5px 5px 5px; width: 60px;">
                                <label for="filter_datalimit_whole">Max. Anzahl:
                                </label>
                                <input class="form-control tiny" style="border: solid 1px black; display: block; width: 100%;" type="number"
                                       name="limit" id="limit" min="1"
                                        {% if 'limit' in session['product_filter_infos'] %}
                                        value="{{ session['product_filter_infos']['limit'] }}"
                                       {% endif %}
                                >
                            </th>
                        </tr>
                        <tr>
                            <th style="border: none; box-shadow: none; padding-bottom: 5px;">
                                <div class="table_top_filter" id="tag-top_filter" onclick="show_filter_options('tag')" onmouseover="show_filter_options('tag')" onmouseleave="hide_filter_options('tag')">
                                    <i class="fa fa-caret-down" aria-hidden="true"></i> Tags
                                    <div class="table_top_filter-dropdown visible" id="tag-top_filter-dropdown" onmouseover="show_filter_options('tag')" onmouseleave="hide_filter_options('tag')">
                                        <table class="table table-hover" style="margin-bottom: 0;">
                                            <tbody>
                                                {% for mp in marketplaces %}
                                                    <tr style="padding: 0; margin: 0">
                                                        <td class="small" style="padding: 4px; margin: 0; font-weight: 800">
                                                            <i>{{ mp.name }}</i>
                                                        </td>
                                                    </tr>
                                                    {% for tag in mp_tags[mp.id] %}
                                                        <tr style="padding: 0; margin: 0">
                                                            <td style="padding: 0; margin: 0">
                                                                <label for="tag{{ tag.id }}" style="height:100%; padding:4px; width: 100%; cursor: pointer">
                                                                    <input type="checkbox" value="{{ tag.id }}" class="tag_filter" name="tag_filter" id="tag{{ tag.id }}"
                                                                    {% if tag.id in session['product_filter_infos']['tag_ids'] %} checked {% endif %}> {{ tag.name }}
                                                                </label>
                                                            </td>
                                                        </tr>
                                                    {% endfor %}
                                                {% endfor %}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </th>
                            <th style="border: none; box-shadow: none; padding-bottom: 5px; width: 120px;">
                                <label for="proc_state">Bearbeitungsstand:</label><br>
                                <i class="fa fa-pencil-square-o" aria-hidden="true"></i> <input type="radio" id="currprocstat" name="currprocstat" value="open" style="position: relative; top: 1.5px" {% if session['product_filter_infos']['currprocstat']=='open' %}checked{% endif %}>
                                <i class="fa fa-check-circle-o" aria-hidden="true"></i> <input type="radio" id="currprocstat" name="currprocstat" value="processed" style="position: relative; top: 1.5px" {% if session['product_filter_infos']['currprocstat']=='processed' %}checked{% endif %}>
                                <i class="fa fa-check-circle-o" aria-hidden="true"></i><i class="fa fa-check-circle-o" aria-hidden="true"></i><input type="radio" id="currprocstat" name="currprocstat" value="confirmed" style="position: relative; top: 1.5px" {% if session['product_filter_infos']['currprocstat']=='confirmed' %}checked{% endif %}>
                                <i class="fa fa-circle-o" aria-hidden="true"></i> <input type="radio" id="currprocstat" name="currprocstat" value="" style="position: relative; top: 1.5px" {% if session['product_filter_infos']['currprocstat']==None %}checked{% endif %}>
                            </th>
                            <th style="border: none; box-shadow: none; padding-bottom: 5px; width: 120px;">
                                Release-Datum:<br>
                                <div style="width: 50%; float: left; padding-right: 15px">
                                    <label for="min_sell_date"> Min:
                                    </label>
                                    <input class="form-control tiny" style="border: solid 1px black; display: block; width: 100%;" type="date" name="release_date_min" id="release_date_min" value="{{ session['product_filter_infos']['release_date_min'].strftime('%Y-%m-%d') if  session['product_filter_infos']['release_date_min'] != None }}">
                                </div>
                                <div style="width: 50%; float: left; padding-left: 15px">
                                    <label for="max_sell_date"> Max:
                                    </label>
                                    <input class="form-control tiny" style="border: solid 1px black; display: block; width: 100%;" type="date" name="release_date_max" id="release_date_max" value="{{ session['product_filter_infos']['release_date_max'].strftime('%Y-%m-%d') if  session['product_filter_infos']['release_date_max'] != None }}">
                                </div>
                            </th>
                            <th style="border: none; box-shadow: none; padding-bottom: 5px; width: 60px;">
                                <button class="standardbutton tiny blackbutton visible" style="float: right; margin: 0" type="submit" value="filter" name="btn">
                                    <i class="fa fa-filter" aria-hidden="true"></i> Filtern
                                </button>
                            </th>

                        </tr>
                    </thead>
                </table>
            </div>
            <input type="hidden" name="order_by" id="order_by" value="{{ session['product_filter_infos']['order_by'] }}"/>
            <input type="hidden" name="order_dir" id="order_dir" value="{{ session['product_filter_infos']['order_dir'] }}"/>
            <input type="hidden" name="limit_offset" id="limit_offset" value="{{ session['product_filter_infos']['limit_offset'] }}"/>
        </form>
    </div>
    <div class="box100">
        <div class="box100title">
            <span id="results"></span> Treffer <button type="button" class="smallbutton blackbutton visible tiny" onclick="print_csv()"><i class="fa fa-file-o" aria-hidden="true"></i> CSV</button>
        </div>
        <div class="box100title">
            Seite: <input id="page" type="number" max="" min="1" value="{{ session['product_filter_infos']['limit_offset'] + 1 }}" style="width: 50px" onchange="turnpage(this.value)">
            / <span id="num_pages_upper"></span>
        </div>
    </div>
    <div class="box100">
        <form id="red_form" action="{{ url_for('center_redirect_product') }}" method="POST">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
            <table class="table table-hover tiny" style="text-align: left">
                <thead class="black">
                    <tr>
                        <th style="position: relative">
                            <label for="product" class="clickable_rowbox" style="width: 40px; height: 50px; padding: 15px; position: absolute; top:0;cursor: pointer">
                                <input type="checkbox" id="product" style="cursor: pointer" onchange="selectall_products(this.checked)">
                            </label>
                        </th>
                        <th>
                            <div class="sortable" onclick="sort_products('id')">
                                ID
                                {% if session['product_filter_infos']['order_by'] == 'id' %}
                                    {% if session['product_filter_infos']['order_dir'] == 'ASC' %}
                                        <i class="fa fa-caret-up" aria-hidden="true"></i>
                                    {% else %}
                                        <i class="fa fa-caret-down" aria-hidden="true"></i>
                                    {% endif %}
                                {% endif %}
                            </div>
                            <div class="sortable" onclick="sort_products('hsp_id')">
                                HSP-ID
                                {% if session['product_filter_infos']['order_by'] == 'hsp_id' %}
                                    {% if session['product_filter_infos']['order_dir'] == 'ASC' %}
                                        <i class="fa fa-caret-up" aria-hidden="true"></i>
                                    {% else %}
                                        <i class="fa fa-caret-down" aria-hidden="true"></i>
                                    {% endif %}
                                {% endif %}
                            </div>
                            <div class="sortable" onclick="sort_products('internal_id')">
                                Interne-ID
                                {% if session['product_filter_infos']['order_by'] == 'internal_id' %}
                                    {% if session['product_filter_infos']['order_dir'] == 'ASC' %}
                                        <i class="fa fa-caret-up" aria-hidden="true"></i>
                                    {% else %}
                                        <i class="fa fa-caret-down" aria-hidden="true"></i>
                                    {% endif %}
                                {% endif %}
                            </div>
                        </th>
                        <th style="vertical-align: top">
                            <div class="sortable"  onclick="sort_products('name')">
                                Name
                                {% if session['product_filter_infos']['order_by'] == 'name' %}
                                    {% if session['product_filter_infos']['order_dir'] == 'ASC' %}
                                        <i class="fa fa-caret-up" aria-hidden="true"></i>
                                    {% else %}
                                        <i class="fa fa-caret-down" aria-hidden="true"></i>
                                    {% endif %}
                                {% endif %}
                                <br>
                                Tags
                            </div>
                        </th>
                        <th style="vertical-align: top">
                        </th>
                        <th style="vertical-align: top">
                            Listed
                        </th>
                        {% for stock in stocks %}
                            {% if stock.owned %}
                                <th style="vertical-align: top">
                                    <div class="sortable"  onclick="sort_products('stock_{{ stock.id|string }}')">
                                        {{ stock.name }}<br>
                                        {{ stock.get_supplier_label() }}
                                        {% if session['product_filter_infos']['order_by'] == 'stock_'+stock.id|string %}
                                            {% if session['product_filter_infos']['order_dir'] == 'ASC' %}
                                                <i class="fa fa-caret-up" aria-hidden="true"></i>
                                            {% else %}
                                                <i class="fa fa-caret-down" aria-hidden="true"></i>
                                            {% endif %}
                                        {% endif %}
                                    </div>
                                </th>
                            {% endif %}
                        {% endfor %}
                        <th style="vertical-align: top; text-align: center">
                            L-VK
                        </th>
                        <th style="vertical-align: top; text-align: center">
                            Suchmodus
                        </th>
                    </tr>
                </thead>
                <tbody id="table_body" style="border-bottom: solid 1px rgb(222, 226, 230);">
                </tbody>
            </table>
            <div id="loader" class="box100" style="position: relative; height: 200px">
                <div class="loader"></div>
            </div>
            <div class="tiny" style="text-align: left; width: 400px; padding: 10px">
                <input hidden disabled type="checkbox" class="send_all" id="send_all" name="send_all" value="True">
                <label hidden for="send_all" >Alle Produkte (inkl. auf dieser Seite nicht aufgeführte)</label>
                <label for="service" style="padding: 5px">Auswahl
                <select id="service" name="service" style="width: 180px">
                    <option value="pim">Zu PIM</option>
                    <option value="quickedit">Schnell einstellen</option>
                    <option value="mark_processed">Als bearbeitet markieren</option>
                    {% if 'Admin' in session['roles'] %}
                        <option value="mark_confirmed">Bearbeitung akzeptieren</option>
                        <option value="mark_review">In Nachbearbeitung schicken</option>
                        <option value="mark_processable">Zur Bearbeitung freigeben</option>
                        <option value="export">Exportieren</option>
                        {% for mp in marketplaces %}
                            <option value="mp_export-{{ mp.id }}">{{ mp.name }}-Export</option>
                        {% endfor %}
                        {% for mp in marketplaces %}
                            <option value="mp_delete-{{ mp.id }}">Bei {{ mp.name }} löschen</option>
                        {% endfor %}
                        <option value="delete">löschen</option>
                        <option value="ab_update_products">Afterbuy-Produkt-Update</option>
                        <option value="ab_update_product_prices">Afterbuy-Produktpreis-Update</option>
                    {% endif %}
                    <option value="product_attributes">Produkt-Attribute</option>
                    <option value="product_features">Produkt-Features</option>
                    <option value="marketplace_data">Marketplace-Attribute</option>
                    {% if 'Admin' in session['roles'] %}
                        <option value="pricingactions">Pricing-Aktionen</option>
                        <option value="activate_searchmode">Suchmodus aktivieren</option>
                        <option value="confirm_products">Produkt konfirmieren</option>
                    {% endif %}
                </select>
                </label>
                <button name="button" type="button" class="standardbutton visible blackbutton" style="float: right; margin-top: 0" onclick="submit_red_form()">
                    <i class="fa fa-play-circle-o" aria-hidden="true"></i> Ausführen
                </button>
            </div>
        </form>
        <div class="box100title">
            Seite: <input id="page" type="number" max="" min="1" value="{{ session['product_filter_infos']['limit_offset'] + 1 }}" style="width: 50px" onchange="turnpage(this.value)">
            / <span id="num_pages_lower"></span>
        </div>
        <div id="ScreenDarkener">
            <div class="loader"></div>
        </div>
    </div>
    <script>
        function print_csv() {
            window.open('/center/product/products/print_csv');
        }
        var csrftoken = $('meta[name=csrf-token]').attr('content');

        $.ajaxSetup({
            beforeSend: function(xhr, settings) {
                if (!/^(GET|HEAD|OPTIONS|TRACE)$/i.test(settings.type)) {
                    xhr.setRequestHeader("X-CSRFToken", csrftoken)
                }
            }
        });

        function generate_rows(){
            var table_body = document.getElementById('table_body');
            table_body.innerHTML = '';
            document.getElementById('loader').style.display = 'Block';
            fetch("{{ url_for('center_product_products_load') }}").then(function (response) {
                response.json().then(function (data) {
                    document.getElementById('loader').style.display = 'None';
                    for (var i = 0; i < data.data.length; i++) {
                        var t_row = table_body.insertRow();
                        t_row.className = 'trclick';
                        var checkbox_cell = t_row.insertCell();
                        checkbox_cell.style.position = 'relative';
                        var checkbox = '<td style="position: relative">';
                        checkbox += '<label for="product' + data.data[i].id + '" class="clickable_rowbox" style="width: 50px; height: 50px; padding: 15px; position: absolute; top:0;cursor: pointer" onclick="event.cancelBubble=true;">';
                        checkbox += '<input value="' + data.data[i].id + '" type="checkbox" name="products" class="products" id="product' + data.data[i].id + '" style="cursor: pointer">';
                        checkbox += '</label>';
                        checkbox_cell.innerHTML = checkbox;
                        var id_cell = t_row.insertCell();
                        id_cell.innerHTML = data.data[i].id + '<br>' + data.data[i].hsp_id  + '<br>' + data.data[i].internal_id;
                        var name_cell = t_row.insertCell();
                        var name =  data.data[i].name + '<br>';
                        var tag_table = '<table style="all: revert;">';
                        {% for mp in marketplaces %}
                            tag_table += '<tr style="all: revert;">';
                            tag_table += '<td style="all: revert; padding-left: 0"><img src="{{ url_for('static', filename='images/foreignicons/' + mp.name + '_icon.png') }}" style="height:15px; width: 15px; margin: 2px"></td>';
                            tag_table += '<td style="all: revert;">';
                            for (var j = 0; j < data.data[i].mp_tags[{{ mp.id }}].length; j++) {
                                tag_table += '<div class="smallbutton black supertiny visible">' + data.data[i].mp_tags[{{ mp.id }}][j] + '</div>';
                            }
                            tag_table += '</td>';
                            tag_table += '</tr>';
                        {% endfor %}
                        tag_table += '</table>';
                        name_cell.innerHTML = name + tag_table;
                        var link_cell = t_row.insertCell();
                        var links = '<div class="smallbutton visible whitebutton" onclick="window.open(\'/center/product/product/' +  data.data[i].id + '\');event.cancelBubble=true;" style="width: 170px; margin: 2px">';
                        links += 'Produkt-Attribute';
                        links += '</div>';
                        links += '<div class="smallbutton visible whitebutton" onclick="window.open(\'/center/product/features/' +  data.data[i].id + '\');event.cancelBubble=true;" style="width: 170px; margin: 2px">';
                        links += 'Produkt-Features';
                        links += '</div><br>';
                        links += '<div class="smallbutton visible whitebutton" onclick="window.open(\'/center/product/marketplace_data/' +  data.data[i].id + '\');event.cancelBubble=true;" style="width: 170px; margin: 2px">';
                        links += 'Marketplace-Attribute';
                        links += '</div>';
                        {% if 'Admin' in session['roles'] %}
                            links += '<div class="smallbutton visible whitebutton" onclick="window.open(\'/center/product/pricingactions/' +  data.data[i].id + '\');event.cancelBubble=true;" style="width: 170px; margin: 2px">';
                            links += 'Pricing-Aktionen';
                            links += '</div>';
                        {% endif %}
                        link_cell.innerHTML = links;
                        var listing_cell = t_row.insertCell();
                        listing_cell.style.padding = '2px 10px 2px 10px';
                        listing_cell.style.position = 'relative';
                        var listing_table = '<table>';
                        listing_table += '<tr>';
                        {% for marketplace in marketplaces %}
                            listing_table += '<td style="padding: 0; border: None" class="glow" onclick="open_marketplace_link(\'' + data.data[i].mp_links[{{ marketplace.id }}] +'\'); event.cancelBubble=true;">';
                            listing_table += '<img src="{{ url_for('static', filename='images/foreignicons/' + marketplace.name + '_icon.png') }}" style="height:15px; width: 15px; margin: 2px">'
                            listing_table += '</td>';
                        {% endfor %}
                        listing_table += '</tr>';
                        listing_table += '<tr>';
                        {% for marketplace in marketplaces %}
                            listing_table += '<td style="padding: 0; border: None">';
                            listing_table += '<label for="{{ marketplace.name }}up' + data.data[i].id + '" class="small clickable_rowbox" style="width: 15px; height: 15px; padding: 3px; position: absolute; top:17px;cursor: pointer">';
                            listing_table += '<input type="checkbox" id="{{ marketplace.name }}up' + data.data[i].id + '" ';
                            if (data.data[i].listed[{{ marketplace.id }}]) {
                                listing_table += 'checked ';
                            }
                            listing_table += 'onchange="change_upload(\'' + data.data[i].id + '\', \'{{ marketplace.id }}\');event.cancelBubble=true;">';
                            listing_table += '</label>';
                            listing_table += '</td>';
                        {% endfor %}
                        listing_table += '</tr>';
                        listing_table += '</table>';
                        listing_cell.innerHTML = listing_table;
                        var stock_cell = t_row.insertCell();
                        var stock = '<div class="whitebutton standardbutton visible" onclick="window.open(\'/center//redirect/stock/products/filtered/' + data.data[i].id + '\', \'_blank\');event.cancelBubble=true;">';
                        stock += data.data[i].stock;
                        stock += '</div>';
                        stock_cell.innerHTML = stock;
                        var short_cell = t_row.insertCell();
                        if (data.data[i].short_sell === true) {short_cell.innerHTML = '<i class="fa fa-thumbs-o-up" aria-hidden="true"></i>';} else {short_cell.innerHTML = '<i class="fa fa-thumbs-o-down" aria-hidden="true"></i>';}
                        var state_cell = t_row.insertCell();
                        if (data.data[i].state == 0) {state_cell.innerHTML = '<i class="fa fa-search" aria-hidden="true"></i>';}
                        else if (data.data[i].state == 1) {state_cell.innerHTML = '<i class="fa fa-exclamation" aria-hidden="true"></i>';}
                        else if (data.data[i].state == 2) {state_cell.innerHTML = '<i class="fa fa-check" aria-hidden="true"></i>';}
                    }
                    document.getElementById("num_pages_upper").innerText = data.pages;
                    document.getElementById("num_pages_lower").innerText = data.pages;
                    document.getElementById("results").innerText = data.results;
                });
            });
        }

        generate_rows();

        function submit_red_form(){
            if (document.getElementById('service').value==='export'
                || document.getElementById('service').value==='ab_export'
                {% for mp in marketplaces %}
                || document.getElementById('service').value==='mp_export-{{ mp.id }}'
                {% endfor %}
                {% for mp in marketplaces %}
                || document.getElementById('service').value==='mp_delete-{{ mp.id }}'
                {% endfor %}
                || document.getElementById('service').value==='pim'
                || document.getElementById('service').value==='delete'
                || document.getElementById('service').value==='ab_update_product_prices'
                || document.getElementById('service').value==='activate_searchmode'
                || document.getElementById('service').value==='confirm_products'
                || document.getElementById('service').value==='mark_confirmed'
                || document.getElementById('service').value==='mark_processable'
                || document.getElementById('service').value==='mark_processed'
                || document.getElementById('service').value==='quickedit'){
                document.getElementById('red_form').submit()
            } else if (document.getElementById('service').value==='ab_update_products'){

                document.getElementById("ScreenDarkener").style.display = 'Block';
                setTimeout(function() {
                    document.getElementById("ScreenDarkener").style.opacity = '0.8';
                }, 200);
                var error_message = 'Beim Upload der folgenden Produkte sind Fehler entstanden: ';
                var error = false;
                var success_message = 'Die Produkte mit den IDs ';
                var checks = document.getElementsByClassName('products');
                var done = 0;
                var max_index = 0;
                for (var j = 0; j < checks.length; j++) {
                    if (checks[j].checked === true) {
                        max_index += 1 ;
                        var p_id = checks[j].value;
                        $.ajax({
                            url: "{{ url_for('center_product_update_afterbuy_products') }}",
                            type: "POST",
                            data: {'p_id': p_id},
                            success: function (data) {
                                if (data.status === 'danger') {
                                    error_message += data.p_id + ', ';
                                    error = true;
                                } else {
                                    success_message += data.p_id + ', ';
                                }
                                done += 1;
                            },
                            error: function () {
                                document.getElementById("ScreenDarkener").style.opacity = '0';
                                setTimeout(function () {
                                    document.getElementById("ScreenDarkener").style.display = 'None';
                                }, 200);
                                document.getElementById('price_update_message').innerText = 'ERROR';
                                document.getElementById('price_update_message').className = 'alert alert-success small visible messagedown';
                                setTimeout(function () {
                                    document.getElementById('price_update_message').className = 'alert alert-success small visible';
                                }, 6000)
                            }
                        });
                    }
                }
                function check() {
                    if (done!==max_index) {
                        return setTimeout(check, 1000);
                    } else{
                        success_message = success_message.substring(0, success_message.length - 2);
                        document.getElementById("ScreenDarkener").style.opacity = '0';
                        setTimeout(function () {
                            document.getElementById("ScreenDarkener").style.display = 'None';
                        }, 200);
                        if (error === true){
                            var msg = error_message + '. ' + success_message + ' wurden erfolgreich geupdated.';
                            document.getElementById('price_update_message').innerText = msg;
                            document.getElementById('price_update_message').className = 'alert alert-danger small visible messagedown';
                            setTimeout(function () {
                                document.getElementById('price_update_message').className = 'alert alert-danger small visible';
                            }, 6000)
                        } else{
                            var msg = success_message + ' wurden erfolgreich geupdated.';
                            document.getElementById('price_update_message').innerText = msg;
                            document.getElementById('price_update_message').className = 'alert alert-success small visible messagedown';
                            setTimeout(function () {
                                document.getElementById('price_update_message').className = 'alert alert-success small visible';
                            }, 6000)
                        }
                    }
                }
                check();
            } else {
                var checked = $('.products:checkbox:checked');
                for (var i=0; i<checked.length; i++){
                    if (document.getElementById('service').value==='product_attributes') {
                        window.open('/center/product/product/'+checked[i].value, '_blank')
                    }
                    else if (document.getElementById('service').value==='product_features') {
                        window.open('/center/product/features/'+checked[i].value, '_blank')
                    }
                    else if (document.getElementById('service').value==='marketplace_data') {
                        window.open('/center/product/marketplace_data/'+checked[i].value, '_blank')
                    }
                    else if (document.getElementById('service').value==='pricingactions') {
                        window.open('/center/product/pricingactions/'+checked[i].value, '_blank')
                    }
                }
            }
        }
        function open_marketplace_link(link) {
            window.open(link, '_blank');
        }

        function find_products(val){
            var letters = /^[0-9A-Za-zÀ-ž\u0370-\u03FF\u0400-\u04FF]+$/;
            if(val.match(letters)) {
                fetch('/center/product/products/find_products/' + val).then(function (response) {
                    response.json().then(function (data) {
                        document.getElementById("product-datalist").innerHTML = data.out;
                    });
                });
            }
        }
        function add_product() {
            var value = document.getElementById('product').value;
            var values = value.split(' - ');
            var type = document.getElementById('product_type').value;
            if (values.length > 2 && !isNaN(Number(values[0])) && !isNaN(Number(values[1])) && !isNaN(Number(values[2]))) {
                if (type === 'id') {
                    var prod_id = document.getElementById('product').value.split(" - ")[0];
                } else if (type === 'Internal_ID') {
                    prod_id = document.getElementById('product').value.split(" - ")[1];
                } else if (type === 'HSP_ID') {
                    prod_id = document.getElementById('product').value.split(" - ")[2];
                }
                var prod_ids = document.getElementById('product_ids');
                if (prod_ids.value.replace(' ', '') === '') {
                    prod_ids.value = prod_id;
                }
                else {
                    prod_ids.value += ';' + prod_id;
                }
            } else {
                var list = document.getElementById("product-datalist").children;
                for (var i = 0; i < list.length; i++) {
                    if (type === 'id') {
                        prod_id = list[i].value.split(" - ")[0];
                    } else if (type === 'Internal_ID') {
                        prod_id = list[i].value.split(" - ")[1];
                    } else if (type === 'HSP_ID') {
                        prod_id = list[i].value.split(" - ")[2];
                    }
                    prod_ids = document.getElementById('product_ids');
                    if (prod_ids.value.replace(' ', '') === '') {
                        prod_ids.value = prod_id;
                    }
                    else {
                        prod_ids.value += ';' + prod_id;
                    }
                }
            }
        }

        function transform_ids(val) {
            old_type = document.getElementById('product_type').value;
            document.getElementById('product_type').value = val;
            ids = document.getElementById('product_ids').value.replace(/(?:\r\n|\r|\n|,)/g, ';');
            fetch('/center/product/dynamic_pricing/transform_ids/'+ids+','+old_type+','+val).then(function (response) {
                response.json().then(function (data) {
                    document.getElementById('product_ids').value = data.ids;
                    if(data.not_found!==''){
                        alert("Die IDs "+data.not_found+" konnten nicht umgewandelt werden.");
                    }
                });
            });
        }

        function change_upload(product_id, marketplace_id) {
            fetch('/center/product/products/change_upload_status/' + product_id + ',' + marketplace_id);
        }

        function turnpage(val){
            document.getElementById('limit_offset').value = Number(val) - 1;
            setTimeout(function() {
                document.filterform.submit();
            }, 200);
        }

        function sort_products(val){
            var order_by = document.getElementById('order_by');
            var order_dir = document.getElementById('order_dir');
            if (order_by.value === val) {
                if (order_dir.value === 'ASC') {
                    order_dir.value = 'DESC';
                } else {
                    order_dir.value = 'ASC';
                }
            } else {
                order_by.value = val;
                order_dir.value = 'DESC';
            }
            setTimeout(function() {
                document.filterform.submit();
            }, 200);
        }

        function showproduct(id) {
            window.open('/center/product/product/'+ id, '_blank');
        }

        function selectall_products(check) {
            all = document.getElementsByClassName("products");
            if (check===true){
                for (i=0; i < all.length ; i++){
                    all[i].checked = true;
                    }
                }
            else{
                for (i=0; i < all.length ; i++){
                    all[i].checked = false;
                    }
                }
        }

        function show_filter_options(type){
            document.getElementById(type+'-top_filter-dropdown').style.display = 'Block';
            setTimeout(function () {
                document.getElementById(type+'-top_filter-dropdown').style.opacity = '1.0';
            }, 100);
        }

        function hide_filter_options(type){
            obj = document.getElementById(type);
            setTimeout(function () {
                if (! $(obj).is(':focus')){
                    document.getElementById(type+'-top_filter-dropdown').style.opacity = '0.0';
                    setTimeout(function () {
                        document.getElementById(type+'-top_filter-dropdown').style.display = 'None';
                    }, 100);
                }}, 200);
            if (! $(obj).is(':focus')){
                document.getElementById(type+'-top_filter-dropdown').style.opacity = '0.0';
                setTimeout(function () {
                    document.getElementById(type+'-top_filter-dropdown').style.display = 'None';
                }, 100);
            }
        }

        function selectall(check, type) {
            all = document.getElementsByClassName(type+"_filter");
            if (check==true){
                for (i=0; i < all.length ; i++){
                    all[i].checked = true;
                    }
                }
            else{
                for (i=0; i < all.length ; i++){
                    all[i].checked = false;
                    }
                }
        }
    </script>
{%endblock%}