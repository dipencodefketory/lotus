{% extends 'center/basis.html' %}
{% block title %}Sales{% endblock %}

{% block addsheets %}
    <link rel="stylesheet" type="text/css" href="{{ url_for('static',filename='css/center/orders.css')}}">
{% endblock %}

{% block ext %}
    <div class="box100" style="text-align: left">
        <form action="" method="POST" name="filterform" style="padding-top: 3px">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
            <input type="text" name="checker" value="filter_sales" hidden>
            <div class="splitleft">
                <div class="form-group" style="margin-top: 20px">
                    <label for="product_ids" style="width: 100%">Produkte (IDs an Semikolon trennen!)
                        <div style="float: right">
                            <input type="radio" value="id" id="id" class="id_type"
                                   name="id_type" onclick="transform_ids(this.value)"
                                    {% if 'product_id_type' in session['orders_sales_filter'] %}
                                    {% if session['orders_sales_filter']['product_id_type'] == 'id' %}
                                        checked
                                    {% endif %}
                                    {% else %}
                                        checked
                                    {% endif %}
                            >
                            <label for="id" style="margin: 0; padding-bottom: 0">ID
                            </label>
                            <input type="radio" value="Internal_ID" id="Internal_ID" class="id_type"
                                   name="id_type" onclick="transform_ids(this.value)"
                                    {% if 'product_id_type' in session['orders_sales_filter'] %}
                                    {% if session['orders_sales_filter']['product_id_type'] == 'Internal_ID' %}
                                        checked
                                    {% endif %}
                                    {% endif %}
                            >
                            <label for="Internal_ID" style="margin: 0; padding-bottom: 0">Interne ID
                            </label>
                            <input type="radio" value="HSP_ID" id="HSP_ID" class="id_type"
                                   name="id_type" onclick="transform_ids(this.value)"
                                    {% if 'product_id_type' in session['orders_sales_filter'] %}
                                    {% if session['orders_sales_filter']['product_id_type'] == 'HSP_ID' %}
                                        checked
                                    {% endif %}
                                    {% endif %}
                            >
                            <label for="HSP_ID" style="margin: 0; padding-bottom: 0">HSP-ID
                            </label>
                            <input hidden name="product_type" id="product_type" value="{{ session['orders_sales_filter']['product_id_type'] if session['orders_sales_filter']['product_id_type'] else 'id' }}">
                        </div>
                    </label>
                    <textarea rows="4" id="product_ids" style="border: solid 1px black;"  name="product_ids" class="form-control">{% for p in session['orders_sales_filter']['product_ids'] %}{{ p }};{% endfor %}</textarea>
                    <span class="supertiny formwarning" id="product_ids_warning">Keine Eingabe!</span>
                    <div style="position:relative;">
                        <input type="text" name="product" style="border: solid 1px black;"  class="form-control" id="product" list="product-datalist" style="padding-right: 120px" onkeyup="find_products(this.value)">
                        <span class="supertiny formwarning" id="product_warning">Nur Ziffern erlaubt!</span>
                        <datalist id="product-datalist" onmouseover="show_filter_options('product')" onmouseleave="hide_filter_options('product')" >

                        </datalist>
                        <button type="button" class="fromfield_blackbutton" name="btn" onclick="add_product()" id="attributebtn">
                            <i class="fa fa-caret-up" aria-hidden="true"></i> hinzufügen
                        </button>
                    </div>
                </div>
            </div>
            <div class="splitright">
                <table class="table tiny" style="margin-bottom: 0; text-align: left; border: none; box-shadow: none">
                    <thead style="border: none; box-shadow: none">
                        <tr>
                            <th style="border: none; box-shadow: none; padding-bottom: 5px;">
                                Verkaufsdatum:<br>
                                <label for="min_sale_date"> Min:
                                </label>
                                <input class="form-control tiny" style="border: solid 1px black; display: block; width: 100%;" type="date" name="min_sale_date" id="min_sale_date" value="{{ session['orders_sales_filter']['min_sale_date'].strftime('%Y-%m-%d') }}">
                            </th>
                            <th style="border: none; box-shadow: none; padding-bottom: 5px;">
                                <label for="max_sale_date"> Max:
                                </label>
                                <input class="form-control tiny" style="border: solid 1px black; display: block; width: 100%;" type="date" name="max_sale_date" id="max_sale_date" value="{{ session['orders_sales_filter']['max_sale_date'].strftime('%Y-%m-%d') }}">
                            </th>
                            <th style="border: none; box-shadow: none; padding-bottom: 5px;">
                                Releasedatum:<br>
                                <label for="min_release_date"> Min:
                                </label>
                                <input class="form-control tiny" style="border: solid 1px black; display: block; width: 100%;" type="date" name="min_release_date" id="min_release_date" value="{{ session['orders_sales_filter']['min_release_date'].strftime('%Y-%m-%d') if session['orders_sales_filter']['min_release_date'] else None }}">
                            </th>
                            <th style="border: none; box-shadow: none; padding-bottom: 5px;">
                                <label for="max_release_date"> Max:
                                </label>
                                <input class="form-control tiny" style="border: solid 1px black; display: block; width: 100%;" type="date" name="max_release_date" id="max_release_date" value="{{ session['orders_sales_filter']['max_release_date'].strftime('%Y-%m-%d') if session['orders_sales_filter']['max_release_date'] else None }}">
                            </th>
                        </tr>
                        <tr>
                            <th style="border: none; box-shadow: none; padding-bottom: 5px;">
                                VK Stückzahl:<br>
                                <label for="min_sale"> Min:
                                </label>
                                <input class="form-control tiny" style="border: solid 1px black; display: block; width: 100%;" type="number" name="min_sale" id="min_sale" value="{{ session['orders_sales_filter']['min_sale'] }}">
                            </th>
                            <th style="border: none; box-shadow: none; padding-bottom: 5px;">
                                <label for="max_sale"> Max:
                                </label>
                                <input class="form-control tiny" style="border: solid 1px black; display: block; width: 100%;" type="number" name="max_sale" id="max_sale" value="{{ session['orders_sales_filter']['max_sale'] }}">
                            </th>
                            <th style="border: none; box-shadow: none; padding-bottom: 5px;">
                                Auf Lager:<br>
                                <label for="min_stock"> Min:
                                </label>
                                <input class="form-control tiny" style="border: solid 1px black; display: block; width: 100%;" type="number" name="min_stock" id="min_stock" value="{{ session['orders_sales_filter']['min_stock'] }}">
                            </th>
                            <th style="border: none; box-shadow: none; padding-bottom: 5px;">
                                <label for="max_stock"> Max:
                                </label>
                                <input class="form-control tiny" style="border: solid 1px black; display: block; width: 100%;" type="number" name="max_stock" id="max_stock" value="{{ session['orders_sales_filter']['max_stock'] }}">
                            </th>
                        </tr>
                        <tr>
                            <th style="border: none; box-shadow: none; padding-bottom: 5px;">
                                <label for="limit_page"> Ergebnisse pro Seite:
                                </label>
                                <input class="form-control tiny" style="border: solid 1px black; display: block; width: 100%;" type="number" name="limit_page" id=limit_page" value="{{ session['orders_sales_filter']['limit_page'] }}">
                            </th>
                            <th style="border: none; box-shadow: none; padding-bottom: 5px;">
                            </th>
                            <th style="border: none; box-shadow: none; padding-bottom: 5px;">
                            </th>
                            <th style="border: none; box-shadow: none; padding-bottom: 5px;">
                                <button class="standardbutton tiny blackbutton visible" style="float: right; margin: 0" type="submit" value="filter" name="btn">
                                    <i class="fa fa-filter" aria-hidden="true"></i> Filtern
                                </button>
                            </th>
                        </tr>
                    </thead>
                </table>
            </div>
            <input type="hidden" name="order_by" id="order_by" value="{{ session['orders_sales_filter']['order_by'] }}"/>
            <input type="hidden" name="order_dir" id="order_dir" value="{{ session['orders_sales_filter']['order_dir'] }}"/>
            <input type="hidden" name="limit_offset" id="limit_offset" value="{{ session['orders_sales_filter']['limit_offset'] }}"/>
        </form>
    </div>
    <div class="box100">
        <div class="box100title" id="results">
        </div>
        <div class="box100title">
            Seite: <input id="page" type="number" min="1" value="{{ session['orders_sales_filter']['limit_offset'] + 1 }}" style="width: 50px" onchange="turnpage(this.value)">
            / <span id="all_results_upper"></span>
        </div>
        <form name="order_form" action="" method="POST">
            <input type="text" name="checker" value="order_form" hidden>
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
            <table id="results" class="table tiny" style="text-align: left">
                <thead class="black">
                    <tr>
                        <th style="vertical-align: top">
                            <div class="sortable" onclick="sort_results('p_id')">
                                ID
                                {% if session['orders_sales_filter']['order_by'] == 'p_id' %}
                                    {% if session['orders_sales_filter']['order_dir'] == 'ASC' %}
                                        <i class="fa fa-caret-up" aria-hidden="true"></i>
                                    {% else %}
                                        <i class="fa fa-caret-down" aria-hidden="true"></i>
                                    {% endif %}
                                {% endif %}
                            </div>
                            <div class="sortable" onclick="sort_results('p_hsp_id')">
                                HSP-ID
                                {% if session['orders_sales_filter']['order_by'] == 'p_hsp_id' %}
                                    {% if session['orders_sales_filter']['order_dir'] == 'ASC' %}
                                        <i class="fa fa-caret-up" aria-hidden="true"></i>
                                    {% else %}
                                        <i class="fa fa-caret-down" aria-hidden="true"></i>
                                    {% endif %}
                                {% endif %}
                            </div>
                            <div class="sortable" onclick="sort_results('p_internal_id')">
                                Interne-ID
                                {% if session['orders_sales_filter']['order_by'] == 'p_internal_id' %}
                                    {% if session['orders_sales_filter']['order_dir'] == 'ASC' %}
                                        <i class="fa fa-caret-up" aria-hidden="true"></i>
                                    {% else %}
                                        <i class="fa fa-caret-down" aria-hidden="true"></i>
                                    {% endif %}
                                {% endif %}
                            </div>
                        </th>
                        <th style="vertical-align: top">
                            <div class="sortable"  onclick="sort_results('name')">
                                Name
                                {% if session['orders_sales_filter']['order_by'] == 'p_name' %}
                                    {% if session['orders_sales_filter']['order_dir'] == 'ASC' %}
                                        <i class="fa fa-caret-up" aria-hidden="true"></i>
                                    {% else %}
                                        <i class="fa fa-caret-down" aria-hidden="true"></i>
                                    {% endif %}
                                {% endif %}
                            </div>
                        </th>
                        <th style="vertical-align: top">
                            <div class="sortable" style="padding-left: 0; margin-left: 0" onclick="sort_results('pa_name')">
                                Aktuelle Aktion
                                {% if session['orders_sales_filter']['order_by'] == 'pa_name' %}
                                    {% if session['orders_sales_filter']['order_dir'] == 'ASC' %}
                                        <i class="fa fa-caret-up" aria-hidden="true"></i>
                                    {% else %}
                                        <i class="fa fa-caret-down" aria-hidden="true"></i>
                                    {% endif %}
                                {% endif %}
                            </div>
                        </th>
                        <th style="vertical-align: top">
                            <table>
                                <tbody>
                                    <tr>
                                        <td style="padding: 0.25rem 0.5rem;"></td>
                                        <td style="padding: 0.25rem 0.5rem;">Stck.</td>
                                        <td style="padding: 0.25rem 0.5rem;">VK-Preis</td>
                                        <td style="padding: 0.25rem 0.5rem;">Versand</td>
                                        <td style="padding: 0.25rem 0.5rem;">Eig. Marge</td>
                                        <td style="padding: 0.25rem 0.5rem;">Opt. Marge</td>
                                    </tr>
                                    {% for mp in marketplaces %}
                                    <tr>
                                        <td style="padding: 0.25rem 0.5rem; text-align: center;">
                                            <img src="/static/images/foreignicons/{{ mp.name }}_icon.png" style="height:15px; width: 15px; margin: 2px">
                                        </td>
                                        <td style="padding: 0.25rem 0.5rem; text-align: center;">
                                            <div style="height: 15px; width: 15px; margin: 2px; display: inline-block; border: solid white 1px" class="glow" onclick="sort_results('mp-{{ mp.id }}-num')">
                                            {% if session['orders_sales_filter']['order_by'] == 'mp-' + mp.id|string + '-num' %}
                                                {% if session['orders_sales_filter']['order_dir'] == 'ASC' %}
                                                    <i class="fa fa-caret-up" aria-hidden="true"></i>
                                                {% else %}
                                                    <i class="fa fa-caret-down" aria-hidden="true"></i>
                                                {% endif %}
                                            {% endif %}
                                            </div>
                                        </td>
                                        <td style="padding: 0.25rem 0.5rem; text-align: center;">
                                            <div style="height: 15px; width: 15px; margin: 2px; display: inline-block; border: solid white 1px" class="glow" onclick="sort_results('mp-{{ mp.id }}-price')">
                                            {% if session['orders_sales_filter']['order_by'] == 'mp-' + mp.id|string + '-price' %}
                                                {% if session['orders_sales_filter']['order_dir'] == 'ASC' %}
                                                    <i class="fa fa-caret-up" aria-hidden="true"></i>
                                                {% else %}
                                                    <i class="fa fa-caret-down" aria-hidden="true"></i>
                                                {% endif %}
                                            {% endif %}
                                            </div>
                                        </td>
                                        <td style="padding: 0.25rem 0.5rem; text-align: center;">
                                            <div style="height: 15px; width: 15px; margin: 2px; display: inline-block; border: solid white 1px" class="glow" onclick="sort_results('mp-{{ mp.id }}-shipping')">
                                            {% if session['orders_sales_filter']['order_by'] == 'mp-' + mp.id|string + '-shipping' %}
                                                {% if session['orders_sales_filter']['order_dir'] == 'ASC' %}
                                                    <i class="fa fa-caret-up" aria-hidden="true"></i>
                                                {% else %}
                                                    <i class="fa fa-caret-down" aria-hidden="true"></i>
                                                {% endif %}
                                            {% endif %}
                                            </div>
                                        </td>
                                        <td style="padding: 0.25rem 0.5rem; text-align: center;">
                                            <div style="height: 15px; width: 15px; margin: 2px; display: inline-block; border: solid white 1px" class="glow" onclick="sort_results('mp-{{ mp.id }}-own_margin')">
                                            {% if session['orders_sales_filter']['order_by'] == 'mp-' + mp.id|string + '-own_margin' %}
                                                {% if session['orders_sales_filter']['order_dir'] == 'ASC' %}
                                                    <i class="fa fa-caret-up" aria-hidden="true"></i>
                                                {% else %}
                                                    <i class="fa fa-caret-down" aria-hidden="true"></i>
                                                {% endif %}
                                            {% endif %}
                                            </div>
                                        </td>
                                        <td style="padding: 0.25rem 0.5rem; text-align: center;">
                                            <div style="height: 15px; width: 15px; margin: 2px; display: inline-block; border: solid white 1px" class="glow" onclick="sort_results('mp-{{ mp.id }}-chp_margin')">
                                            {% if session['orders_sales_filter']['order_by'] == 'mp-' + mp.id|string + '-chp_margin' %}
                                                {% if session['orders_sales_filter']['order_dir'] == 'ASC' %}
                                                    <i class="fa fa-caret-up" aria-hidden="true"></i>
                                                {% else %}
                                                    <i class="fa fa-caret-down" aria-hidden="true"></i>
                                                {% endif %}
                                            {% endif %}
                                            </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                    <tr>
                                        <td style="padding: 0.25rem 0.5rem; text-align: center;">
                                            &Sigma;
                                        </td>
                                        <td style="padding: 0.25rem 0.5rem; text-align: center;">
                                            <div style="height: 15px; width: 15px; margin: 2px; display: inline-block; border: solid white 1px" class="glow" onclick="sort_results('mp-0-num')">
                                            {% if session['orders_sales_filter']['order_by'] == 'mp-0-num' %}
                                                {% if session['orders_sales_filter']['order_dir'] == 'ASC' %}
                                                    <i class="fa fa-caret-up" aria-hidden="true"></i>
                                                {% else %}
                                                    <i class="fa fa-caret-down" aria-hidden="true"></i>
                                                {% endif %}
                                            {% endif %}
                                            </div>
                                        </td>
                                        <td style="padding: 0.25rem 0.5rem; text-align: center;">
                                            <div style="height: 15px; width: 15px; margin: 2px; display: inline-block; border: solid white 1px" class="glow" onclick="sort_results('mp-0-price')">
                                            {% if session['orders_sales_filter']['order_by'] == 'mp-0-price' %}
                                                {% if session['orders_sales_filter']['order_dir'] == 'ASC' %}
                                                    <i class="fa fa-caret-up" aria-hidden="true"></i>
                                                {% else %}
                                                    <i class="fa fa-caret-down" aria-hidden="true"></i>
                                                {% endif %}
                                            {% endif %}
                                            </div>
                                        </td>
                                        <td style="padding: 0.25rem 0.5rem; text-align: center;">
                                            <div style="height: 15px; width: 15px; margin: 2px; display: inline-block; border: solid white 1px" class="glow" onclick="sort_results('mp-0-shipping')">
                                            {% if session['orders_sales_filter']['order_by'] == 'mp-0-shipping' %}
                                                {% if session['orders_sales_filter']['order_dir'] == 'ASC' %}
                                                    <i class="fa fa-caret-up" aria-hidden="true"></i>
                                                {% else %}
                                                    <i class="fa fa-caret-down" aria-hidden="true"></i>
                                                {% endif %}
                                            {% endif %}
                                            </div>
                                        </td>
                                        <td style="padding: 0.25rem 0.5rem; text-align: center;">
                                            <div style="height: 15px; width: 15px; margin: 2px; display: inline-block; border: solid white 1px" class="glow" onclick="sort_results('mp-0-own_margin')">
                                            {% if session['orders_sales_filter']['order_by'] == 'mp-0-own_margin' %}
                                                {% if session['orders_sales_filter']['order_dir'] == 'ASC' %}
                                                    <i class="fa fa-caret-up" aria-hidden="true"></i>
                                                {% else %}
                                                    <i class="fa fa-caret-down" aria-hidden="true"></i>
                                                {% endif %}
                                            {% endif %}
                                            </div>
                                        </td>
                                        <td style="padding: 0.25rem 0.5rem; text-align: center;">
                                            <div style="height: 15px; width: 15px; margin: 2px; display: inline-block; border: solid white 1px" class="glow" onclick="sort_results('mp-0-chp_margin')">
                                            {% if session['orders_sales_filter']['order_by'] == 'mp-0-chp_margin' %}
                                                {% if session['orders_sales_filter']['order_dir'] == 'ASC' %}
                                                    <i class="fa fa-caret-up" aria-hidden="true"></i>
                                                {% else %}
                                                    <i class="fa fa-caret-down" aria-hidden="true"></i>
                                                {% endif %}
                                            {% endif %}
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </th>
                        <th style="vertical-align: top">
                            Eigenes Lager<br>
                            <div class="sortable" style="padding-left: 0; margin-left: 0" onclick="sort_results('own_stock')">
                                Stückzahl
                                {% if session['orders_sales_filter']['order_by'] == 'own_stock' %}
                                    {% if session['orders_sales_filter']['order_dir'] == 'ASC' %}
                                        <i class="fa fa-caret-up" aria-hidden="true"></i>
                                    {% else %}
                                        <i class="fa fa-caret-down" aria-hidden="true"></i>
                                    {% endif %}
                                {% endif %}
                            </div>
                            <div class="sortable" style="padding-left: 0; margin-left: 0" onclick="sort_results('own_bp')">
                                EK
                                {% if session['orders_sales_filter']['order_by'] == 'own_bp' %}
                                    {% if session['orders_sales_filter']['order_dir'] == 'ASC' %}
                                        <i class="fa fa-caret-up" aria-hidden="true"></i>
                                    {% else %}
                                        <i class="fa fa-caret-down" aria-hidden="true"></i>
                                    {% endif %}
                                {% endif %}
                            </div>
                            <div class="sortable" style="padding-left: 0; margin-left: 0" onclick="sort_results('ordered')">
                                Bestellt
                                {% if session['orders_sales_filter']['order_by'] == 'ordered' %}
                                    {% if session['orders_sales_filter']['order_dir'] == 'ASC' %}
                                        <i class="fa fa-caret-up" aria-hidden="true"></i>
                                    {% else %}
                                        <i class="fa fa-caret-down" aria-hidden="true"></i>
                                    {% endif %}
                                {% endif %}
                            </div>
                        </th>
                        <th style="width: 60px;">
                        </th>
                        <th style="width: 60px;">
                        </th>
                        <th style="width: 60px;">
                        </th>
                    </tr>
                </thead>
                <tbody id="t_body"></tbody>
            </table>
            <div id="loader" class="box100" style="position: relative; height: 200px">
                <div class="loader"></div>
            </div>
            <input name="active_order_fields" id="active_order_fields" hidden>
            <button class="standardbutton tiny blackbutton visible" type="button" value="order" name="btn" onclick="add_orders()">
                <i class="fa fa-floppy-o" aria-hidden="true"></i> Bestellungen anlegen
            </button>
        </form>
        <div class="box100title">
            Seite: <input id="page" type="number" min="1" value="{{ session['orders_sales_filter']['limit_offset'] + 1 }}" style="width: 50px" onchange="turnpage(this.value)">
            / <span id="all_results_lower"></span>
        </div>
    </div>
    <script>
        fetch('/center/orders/sales/load').then(function (response) {
            console.log(response);
            response.json().then(function (data) {
                var table_body = document.getElementById('t_body');
                for (var i = 0; i < data.data.length; i++) {
                    var t_row = table_body.insertRow();
                    var p_ids_cell = t_row.insertCell();
                    var p_ids = data.data[i].p_id + '<br>' + data.data[i].p_internal_id + '<br>' + data.data[i].p_hsp_id;
                    p_ids_cell.innerHTML = p_ids;
                    var p_name_cell = t_row.insertCell();
                    var p_name = data.data[i].p_name;
                    if (data.data[i].pre_order === true) {
                        p_name += '<span class="fa-layers fa-fw" style="position: relative; margin-right: 4px">';
                        p_name += '<i class="fa fa-shopping-cart"></i><i class="fa fa-clock-o" style="left: 10px; top: -2px; position: absolute; font-size: 10px;"></i>';
                        p_name += '</span>';
                    }
                    p_name_cell.innerHTML = p_name;
                    var p_action_cell = t_row.insertCell();
                    var action_div = document.createElement('div');
                    action_div.setAttribute('data-p_id', data.data[i].p_id);
                    action_div.className = 'smallbutton visible whitebutton';
                    action_div.onclick = function () {
                        window.open('/center/product/pricingactions/' + this.getAttribute('data-p_id'));
                        event.cancelBubble=true;
                    };
                    action_div.style.width = '170px';
                    action_div.style.margin = '2px';
                    action_div.innerText = data.data[i].pa_name;
                    p_action_cell.appendChild(action_div);
                    var sales_cell = t_row.insertCell();
                    var sales_table = document.createElement('table');
                    var sales_header = sales_table.insertRow();
                    var sales_header_cell_1 = sales_header.insertCell();
                    sales_header_cell_1.style.padding = '.25rem .5rem';
                    var sales_header_cell_2 = sales_header.insertCell();
                    sales_header_cell_2.style.padding = '.25rem .5rem';
                    sales_header_cell_2.innerText = 'Stck.';
                    var sales_header_cell_3 = sales_header.insertCell();
                    sales_header_cell_3.style.padding = '.25rem .5rem';
                    sales_header_cell_3.innerText = 'VK-Preis';
                    var sales_header_cell_4 = sales_header.insertCell();
                    sales_header_cell_4.style.padding = '.25rem .5rem';
                    sales_header_cell_4.innerText = 'Versand';
                    var sales_header_cell_5 = sales_header.insertCell();
                    sales_header_cell_5.style.padding = '.25rem .5rem';
                    sales_header_cell_5.innerText = 'Eig. Marge';
                    var sales_header_cell_6 = sales_header.insertCell();
                    sales_header_cell_6.style.padding = '.25rem .5rem';
                    sales_header_cell_6.innerText = 'Opt. Marge';
                    {% for mp in marketplaces %}
                    var sales_row = sales_table.insertRow();
                    var mp_info_cell = sales_row.insertCell();
                    mp_info_cell.style.padding = '.25rem .5rem';
                    if (data.data[i]['mp_sales'][{{ mp.id }}]['mp_link'] !== '') {
                        mp_info_cell.className = 'glow';
                        mp_info_cell.setAttribute('data-link', data.data[i]['mp_sales'][{{ mp.id }}]['mp_link']);
                        mp_info_cell.onclick = function () {
                            open_marketplace_link(this.getAttribute('data-link'));
                            event.cancelBubble=true;
                        };
                    }
                    mp_info_cell.style.textAlign = 'center';
                    mp_info_cell.innerHTML = '<img src="{{ url_for('static', filename='images/foreignicons/' + mp.name + '_icon.png')  }}" style="height:15px; width: 15px; margin: 2px">';
                    var mp_num_cell = sales_row.insertCell();
                    mp_num_cell.style.padding = '.25rem .5rem';
                    mp_num_cell.innerText = data.data[i]['mp_sales'][{{ mp.id }}]['num'];
                    var mp_price_cell = sales_row.insertCell();
                    mp_price_cell.style.padding = '.25rem .5rem';
                    mp_price_cell.innerText = data.data[i]['mp_sales'][{{ mp.id }}]['price_eur'];
                    var mp_shipping_cell = sales_row.insertCell();
                    mp_shipping_cell.style.padding = '.25rem .5rem';
                    mp_shipping_cell.style.padding = '.25rem .5rem';
                    mp_shipping_cell.innerText = data.data[i]['mp_sales'][{{ mp.id }}]['shipping_eur'];
                    var mp_own_margin_cell = sales_row.insertCell();
                    mp_own_margin_cell.style.padding = '.25rem .5rem';
                    mp_own_margin_cell.innerText = data.data[i]['mp_sales'][{{ mp.id }}]['own_margin_prc'];
                    var mp_chp_margin_cell = sales_row.insertCell();
                    mp_chp_margin_cell.style.padding = '.25rem .5rem';
                    mp_chp_margin_cell.innerText = data.data[i]['mp_sales'][{{ mp.id }}]['chp_margin_prc'];
                    {% endfor %}
                    var sales_row = sales_table.insertRow();
                    var mp_info_cell = sales_row.insertCell();
                    mp_info_cell.style.padding = '.25rem .5rem';
                    mp_info_cell.style.textAlign = 'center';
                    mp_info_cell.innerHTML = '&Sigma;';
                    var mp_num_cell = sales_row.insertCell();
                    mp_num_cell.style.padding = '.25rem .5rem';
                    mp_num_cell.innerText = data.data[i]['mp_sales'][0]['num'];
                    var mp_price_cell = sales_row.insertCell();
                    mp_price_cell.style.padding = '.25rem .5rem';
                    mp_price_cell.innerText = data.data[i]['mp_sales'][0]['price_eur'];
                    var mp_shipping_cell = sales_row.insertCell();
                    mp_shipping_cell.style.padding = '.25rem .5rem';
                    mp_shipping_cell.innerText = data.data[i]['mp_sales'][0]['shipping_eur'];
                    var mp_own_margin_cell = sales_row.insertCell();
                    mp_own_margin_cell.style.padding = '.25rem .5rem';
                    mp_own_margin_cell.innerText = data.data[i]['mp_sales'][0]['own_margin_prc'];
                    var mp_chp_margin_cell = sales_row.insertCell();
                    mp_chp_margin_cell.style.padding = '.25rem .5rem';
                    mp_chp_margin_cell.innerText = data.data[i]['mp_sales'][0]['chp_margin_prc'];
                    sales_cell.appendChild(sales_table);
                    var own_cell = t_row.insertCell();
                    var lvk = '';
                    if (data.data[i].short_sell === true) {
                        lvk = ' (L-VK)'
                    }
                    own_cell.innerHTML = '<br>' + data.data[i].own_stock + lvk + '<br>' + data.data[i].own_bp_eur + '<br>' + data.data[i].ordered;
                    for (var j = 0; j < data.data[i].ws_offers.length; j++) {
                        var ws_cell = t_row.insertCell();
                        var ws = '<span style="overflow: hidden; white-space: nowrap; text-overflow:ellipsis; text-align: right;">' + data.data[i].ws_offers[j].sup_name + '</span><br>';
                        ws += data.data[i].ws_offers[j].quant + '<br>';
                        ws += data.data[i].ws_offers[j].bp_eur + '<br>';
                        ws += '<input class="order_field" required min="0" value="0" style="width: 60px;" type="number" name="' + data.data[i].ws_offers[j].sup_id + '_' + data.data[i].p_id + '">';
                        ws += '<input hidden name="' + data.data[i].ws_offers[j].sup_id + '_' + data.data[i].p_id +'_price" value="' + data.data[i].ws_offers[j].bp + '">';
                        ws_cell.innerHTML = ws;
                    }
                    for (var k = 0; k < 3-j; k++) {
                        var ws_cell = t_row.insertCell();
                    }
                }
                document.getElementById('all_results_upper').innerText = data.pages;
                document.getElementById('all_results_lower').innerText = data.pages;
                document.getElementById('results').innerText = data.results + ' Treffer';
            });
            document.getElementById('loader').style.display = 'None';
        });

        // fetch('/center/orders/get_sales_data').then(function (response) {
        //     response.json().then(function (data) {
        //         document.getElementById('loader').style.display = 'None';
        //         var table = document.getElementById('results');
        //         table.innerHTML += data.result;
        //         document.getElementById('result_box').innerHTML = data.result_box;
        //     });
        // });

        function add_orders() {
            var order_fields = document.getElementsByClassName('order_field');
            var active_order_fields = [];
            for (var i = 0; i < order_fields.length; i++) {
                if (order_fields[i].value !== '0' && order_fields[i].value !== '') {
                    active_order_fields.push(order_fields[i].name)
                }
            }
            document.getElementById('active_order_fields').value = active_order_fields.join();
            document.order_form.submit();
        }

        function sort_results(val) {
            var order_by = document.getElementById('order_by');
            var order_dir = document.getElementById('order_dir');
            if (order_by.value === val) {
                if (order_dir.value === 'ASC') {
                    order_dir.value = 'DESC';
                } else {
                    order_dir.value = 'ASC';
                }
            } else {
                order_by.value = val;
                order_dir.value = 'DESC';
            }
            setTimeout(function () {
                document.filterform.submit();
            }, 200);
        }

        function turnpage(val){
            document.getElementById('limit_offset').value = Number(val) - 1;
            setTimeout(function() {
                document.filterform.submit();
            }, 200);
        }

        function open_marketplace_link(link) {
            window.open(link, '_blank');
        }

        function find_products(val){
            var letters = /^[0-9A-Za-zÀ-ž\u0370-\u03FF\u0400-\u04FF]+$/;
            if(val.match(letters)) {
                fetch('/center/product/products/find_products/' + val).then(function (response) {
                    response.json().then(function (data) {
                        document.getElementById("product-datalist").innerHTML = data.out;
                    });
                });
            }
        }
        function add_product() {
            var value = document.getElementById('product').value;
            var values = value.split(' - ');
            var type = document.getElementById('product_type').value;
            if (values.length > 2 && !isNaN(Number(values[0])) && !isNaN(Number(values[1])) && !isNaN(Number(values[2]))) {
                if (type === 'id') {
                    var prod_id = document.getElementById('product').value.split(" - ")[0];
                } else if (type === 'Internal_ID') {
                    prod_id = document.getElementById('product').value.split(" - ")[1];
                } else if (type === 'HSP_ID') {
                    prod_id = document.getElementById('product').value.split(" - ")[2];
                }
                var prod_ids = document.getElementById('product_ids');
                if (prod_ids.value.replace(' ', '') === '') {
                    prod_ids.value = prod_id;
                }
                else {
                    prod_ids.value += ';' + prod_id;
                }
            } else {
                var list = document.getElementById("product-datalist").children;
                for (var i = 0; i < list.length; i++) {
                    if (type === 'id') {
                        prod_id = list[i].value.split(" - ")[0];
                    } else if (type === 'Internal_ID') {
                        prod_id = list[i].value.split(" - ")[1];
                    } else if (type === 'HSP_ID') {
                        prod_id = list[i].value.split(" - ")[2];
                    }
                    prod_ids = document.getElementById('product_ids');
                    if (prod_ids.value.replace(' ', '') === '') {
                        prod_ids.value = prod_id;
                    }
                    else {
                        prod_ids.value += ';' + prod_id;
                    }
                }
            }
        }

        function transform_ids(val) {
            old_type = document.getElementById('product_type').value;
            document.getElementById('product_type').value = val;
            ids = document.getElementById('product_ids').value.replace(/(?:\r\n|\r|\n|,)/g, ';');
            fetch('/center/product/dynamic_pricing/transform_ids/'+ids+','+old_type+','+val).then(function (response) {
                response.json().then(function (data) {
                    document.getElementById('product_ids').value = data.ids;
                    if(data.not_found!==''){
                        alert("Die IDs "+data.not_found+" konnten nicht umgewandelt werden.");
                    }
                });
            });
        }
    </script>
{%endblock%}